CREATE VIEW V_APROBADOS(
CICLO,IDCURSOPROG,CURSO,NOMBRE,HORARIO,PROFESOR,APROBADOS,DESAPROBADOS
) AS
WITH PREVIA AS (
SELECT 
	CP.IdCursoProg,
	SUM(CASE WHEN M.PROMEDIO>=11 THEN 1 ELSE 0 END) APROBADOS,
	SUM(CASE WHEN M.PROMEDIO<11 THEN 1 ELSE 0 END) DESAPROBADOS
FROM CursoProgramado CP
JOIN MATRICULA M
ON CP.IdCursoProg = M.IdCursoProg
GROUP BY CP.IdCursoProg
)
SELECT 
	CP.IdCiclo, CP.IdCursoProg, CP.IdCurso,
	C.NomCurso, CP.Horario,
	CASE  
		WHEN CP.IdProfesor IS NULL THEN 'NONE'
		ELSE CP.IdProfesor + ' - ' + PR.ApeProfesor + ' - ' + PR.NomProfesor
	END,
	P.APROBADOS, P.DESAPROBADOS
FROM PREVIA P
JOIN CursoProgramado CP ON P.IdCursoProg = CP.IdCursoProg
JOIN CURSO C ON CP.IdCurso = C.IdCurso
LEFT JOIN Profesor PR ON CP.IdProfesor = PR.IdProfesor
GO


SELECT * FROM V_APROBADOS WHERE IDCURSOPROG = 8183;
GO


SELECT * FROM CursoProgramado WHERE IdProfesor IS NULL;